#!/bin/bash

# Instituto Stellas - Domain Configuration Script
# Generated by Claude Code Assistant

echo "ðŸŒ INSTITUTO STELLAS - CONFIGURAÃ‡ÃƒO DE DOMÃNIO"
echo "================================================"
echo ""

# Verificar se Ã© root
if [ "$EUID" -ne 0 ]; then
    echo "âŒ Este script precisa ser executado como root (sudo)"
    exit 1
fi

# Solicitar domÃ­nio
echo "ðŸ“‹ Exemplos de domÃ­nio:"
echo "   â€¢ stellas.com.br"
echo "   â€¢ institutstellas.com.br"
echo "   â€¢ institutostellas.org.br"
echo ""
read -p "ðŸŒ Digite seu domÃ­nio: " DOMAIN_NAME

if [ -z "$DOMAIN_NAME" ]; then
    echo "âŒ DomÃ­nio nÃ£o pode estar vazio"
    exit 1
fi

echo ""
echo "âœ… Configurando domÃ­nio: $DOMAIN_NAME"
echo ""

# Substituir domÃ­nio no arquivo nginx
sed "s/SUBSTITUA_PELO_SEU_DOMINIO/$DOMAIN_NAME/g" /var/www/stellas/landingpage/nginx-stellas.conf > /etc/nginx/sites-available/stellas

# Ativar site
ln -sf /etc/nginx/sites-available/stellas /etc/nginx/sites-enabled/stellas

# Remover site default se existir
if [ -f "/etc/nginx/sites-enabled/default" ]; then
    rm /etc/nginx/sites-enabled/default
    echo "ðŸ—‘ï¸ Site default removido"
fi

# Testar configuraÃ§Ã£o nginx
echo "ðŸ§ª Testando configuraÃ§Ã£o Nginx..."
if nginx -t; then
    echo "âœ… ConfiguraÃ§Ã£o Nginx vÃ¡lida"
    
    # Recarregar nginx
    echo "ðŸ”„ Recarregando Nginx..."
    systemctl reload nginx
    echo "âœ… Nginx recarregado"
else
    echo "âŒ Erro na configuraÃ§Ã£o Nginx"
    exit 1
fi

# Verificar se Next.js estÃ¡ rodando
echo "ðŸ” Verificando Next.js..."
if curl -s -I http://localhost:5002 | grep -q "200\|301\|302"; then
    echo "âœ… Next.js respondendo na porta 5002"
else
    echo "âš ï¸ Next.js pode nÃ£o estar respondendo na porta 5002"
    echo "   Verifique se o processo estÃ¡ rodando"
fi

echo ""
echo "ðŸŽ‰ CONFIGURAÃ‡ÃƒO CONCLUÃDA!"
echo ""
echo "ðŸ”— ACESSOS:"
echo "   ðŸŒ HTTP:  http://$DOMAIN_NAME (redirecionarÃ¡ para HTTPS)"
echo "   ðŸ”’ HTTPS: https://$DOMAIN_NAME"
echo "   ðŸ“± Local: http://localhost:5002"
echo ""
echo "ðŸ“‹ PRÃ“XIMOS PASSOS:"
echo "   1. Configurar DNS do domÃ­nio para apontar para: $(curl -s ipinfo.io/ip)"
echo "   2. Ativar Cloudflare para SSL automÃ¡tico"
echo "   3. Atualizar monitors no Uptime Kuma"
echo "   4. Testar formulÃ¡rio de contato"
echo ""
echo "ðŸ’¡ DICA: Configure o Cloudflare como proxy (nuvem laranja)"
echo "   para SSL automÃ¡tico e CDN global"
echo ""

# Salvar configuraÃ§Ã£o para logs
echo "DOMAIN_NAME=$DOMAIN_NAME" > /var/www/stellas/landingpage/.domain-config
echo "CONFIGURED_DATE=$(date)" >> /var/www/stellas/landingpage/.domain-config
echo "IP_ADDRESS=$(curl -s ipinfo.io/ip)" >> /var/www/stellas/landingpage/.domain-config

echo "âœ… ConfiguraÃ§Ã£o salva em: /var/www/stellas/landingpage/.domain-config"